<!DOCTYPE html>
<html>
<head>
  <title>Pemindai QR Code dengan Lokasi GPS dan Foto Perangkat</title>
  <style>
    /* Gaya CSS untuk mengatur tampilan */
    #qr-reader {
      width: 300px;
      height: 300px;
      border: 1px solid #ccc;
      margin: 20px auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <h1>Pemindai QR Code dengan Lokasi GPS dan Foto Perangkat</h1>
  <div id="qr-reader"></div>
  <button id="startButton">Mulai Memindai</button>
  <input type="file" id="devicePhotoInput" accept="image/*">
  <table id="result-table">
    <thead>
      <tr>
        <th>No.</th>
        <th>Type Perangkat</th>
        <th>Foto Perangkat</th>
        <th>Foto Serian Number</th>
        <th>Serian Number</th>
        <th>Waktu Pemindaian</th>
        <th>Lokasi GPS</th>
      </tr>
    </thead>
    <tbody id="result-body">
    </tbody>
  </table>

  <script src="html5-qrcode.min.js"></script>
  <script>
    const qrReader = document.getElementById('qr-reader');
    const startButton = document.getElementById('startButton');
    const resultBody = document.getElementById('result-body');
    const devicePhotoInput = document.getElementById('devicePhotoInput');
    let scanCount = 1;

    const html5QrcodeScanner = new Html5QrcodeScanner(
      'qr-reader', { fps: 10, qrbox: 250 }
    );

    // Fungsi untuk meminta izin lokasi
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
      } else {
        alert("Geolocation tidak didukung oleh browser ini.");
      }
    }

    // Fungsi untuk menampilkan posisi saat ini
    function showPosition(position) {
      window.scanLocation = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
    }

    // Fungsi untuk menangani kesalahan saat mendapatkan lokasi
    function showError(error) {
      console.error("Error getting location:", error.message);
      alert("Terjadi kesalahan saat mendapatkan lokasi. Pastikan GPS Anda aktif.");
    }

    function startScanning() {
      getLocation(); // Meminta izin lokasi sebelum memulai pemindaian
      qrReader.style.display = 'block';
      startButton.style.display = 'none';
      html5QrcodeScanner.render(onScanSuccess);
    }

    function onScanSuccess(decodedText, decodedResult) {
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td><span class="math-inline">\{scanCount\}</td\>
<td\><input type\="text" id\="deviceType</span>{scanCount}"></td>
        <td>
          <img src="" alt="Foto Perangkat <span class="math-inline">\{scanCount\}" id\="devicePhotoPreview</span>{scanCount}">
        </td>
        <td>
          <input type="text" id="serialNumberPhoto${scanCount}">
          <input type="file" id="serialNumberPhotoInput${scanCount}" accept="image/*" style="display: none;">
        </td>
        <td><input type="text" id="serialNumber${scanCount}"></td>
        <td><span class="math-inline">\{new Date\(\)\.toLocaleString\(\)\}</td\>
<td\></span>{window.scanLocation ? `${window.scanLocation.lat}, ${window.scanLocation.lng}` : '-'}</td>
      `;
      resultBody.appendChild(newRow);

      const devicePhotoPreview = document.getElementById(`devicePhotoPreview${scanCount}`);

      devicePhotoInput.onchange = function () {
        const reader = new FileReader();
        reader.onload = function (e) {
          devicePhotoPreview.src = e.target.result;
        };
        reader.readAsDataURL(this.files[0]);
