<!DOCTYPE html>
<html>
<head>
    <title>Pemindai QR Code</title>
    <style>
        /* Gaya CSS untuk mengatur tampilan */
        #qr-reader {
            width: 300px;
            height: 300px;
            border: 1px solid #ccc;
            margin: 20px auto;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Pemindai QR Code</h1>
    <div id="qr-reader"></div>
    <button id="startButton">Mulai Memindai</button>
    <table id="result-table">
        <thead>
            <tr>
                <th>No.</th>
                <th>Eviden Foto</th>
                <th>Teks Scan</th>
                <th>Waktu Pemindaian</th>
            </tr>
        </thead>
        <tbody id="result-body">
        </tbody>
    </table>

    <script src="html5-qrcode.min.js"></script>
    <script>
        const qrReader = document.getElementById('qr-reader');
        const startButton = document.getElementById('startButton');
        const resultBody = document.getElementById('result-body');
        let scanCount = 1;

        const html5QrcodeScanner = new Html5QrcodeScanner(
            'qr-reader', { fps: 10, qrbox: 250 }
        );

        function checkGeolocationSupport() {
  if (navigator.geolocation) {
    return true;
  } else {
    alert("Geolocation is not supported by your browser.");
    return false;
  }
}


function captureLocation(onSuccess) {
  if (!checkGeolocationSupport()) return;

  navigator.geolocation.getCurrentPosition(
    (position) => {
      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude; Â  

      onSuccess(latitude, longitude);
    },
    (error) => {
      console.error("Error getting location:", error);
      alert("Failed to capture location.");
    }
  );
}

function embedLocationOnPhoto(photo, latitude, longitude) {
  const canvas = document.createElement('canvas');
  const img = new Image();
  img.onload = () => {
    const context = canvas.getContext('2d');
    const imgWidth = img.width;
    const imgHeight = img.height;
    canvas.width = imgWidth;
    canvas.height = imgHeight + 20; // Add space for location text

    // Draw image on canvas
    context.drawImage(img, 0, 0);

    // Display location text
    context.font = "12px Arial";
    context.fillStyle = "black";
    context.fillText(`Location: Lat: ${latitude}, Long: ${longitude}`, 5, imgHeight + 15);

    const newPhoto = canvas.toDataURL('image/jpeg');
    document.getElementById('photo-preview' + index).src = newPhoto;
  };
  img.src = photo;
}
        
        
        function startScanning() {
            qrReader.style.display = 'block';
            startButton.style.display = 'none';
            html5QrcodeScanner.render(onScanSuccess);
        }

function onScanSuccess(decodedText, decodedResult) {
  const newRow = document.createElement('tr');
  newRow.innerHTML = `
    <td>${scanCount}</td>
    <td><img src="" alt="Preview Photo ${scanCount}" id="photo-preview${scanCount}"></td>
    <td>${decodedText}</td>
    <td>${new Date().toLocaleString()}</td>
  `;
  resultBody.appendChild(newRow);

  captureLocation((latitude, longitude) => {
    takePhoto(scanCount, photo => embedLocationOnPhoto(photo, latitude, longitude));
  });
  html5QrcodeScanner.pause();
  scanCount++;
  startButton.style.display = 'block'; // Tampilkan tombol mulai lagi
}

        function takePhoto(index) {
            const video = document.querySelector('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const photo = canvas.toDataURL('image/jpeg');
            document.getElementById('photo-preview' + index).src = photo;
        }

        startButton.addEventListener('click', startScanning);
    </script>
</body>
</html>
